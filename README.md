# AverageSeeds

Централизованная база данных средних сидов для одного торрент-трекера

Сервис обеспечивает сбор данных о количестве сидов на раздачах трекера, их сохранение, и отдачу клиентам через API. Для
сбора информации о сидах выполняется сканирование раздач раз в час и запись суммарных результатов за день. Всего
информация хранится за 30 прошедших дней + текущий день. 

## API

Все методы API возвращают данные в формате JSON

### GET /seeds

**Параметры:**

- `subsections` — номера подразделов через запятую. Может отсутствовать или быть пустым, если, например, требуется
  просто получить количество обновлений БД
- `days` — номера дней через запятую, где 0 — вчерашний день, 1 — позавчерашний и т.д. Дни могут быть в интервале
  [0,29]. Дни в ответе приходят без номеров и в том порядке, в котором были в запросе, поэтому клиент должен запоминать,
  какие дни и в каком порядке он запрашивал. С версии 0.9.0 можно запрашивать диапазон дней через дефис (например 0-14).
  Несколько диапазонов или смешение форматов не допускаются. Длина параметра ограничена, ограничение рассчитывается 
  автоматически так, чтобы можно было запросить все дни через запятую (сейчас оно составляет 90 символов). 
  Если параметр не указан — возвращаются все дни в порядке от самого нового к самому старому

**Ответ:**

- ~~`success: Boolean`~~ — удалён из API, так как есть коды ответа
- `message: String` — сообщение, которое следует дополнительно вывести пользователю. Всегда присутствует при ошибке,
  может присутствовать при успешном запросе и носить информационный характер
- `mainUpdatesCount: Int[]` — массив из 30 элементов, показывающих количество полных обновлений БД в каждый из 30-ти
  прошедших дней, где 0 – вчерашний день, 1 – позавчерашний, и т.д. Так как БД обновляется каждый час, в
  идеальной ситуации каждый из 30 элементов должен быть равен `24`
- `subsections: Map<Int, Map<Int, Topic>>` — ассоциативный массив, где ключом является номер подраздела, а значением —
  другой ассоциативный массив, где ключом является номер темы, а значением — объект `Topic`
- `Topic: Object` — объект, содержащий информацию о теме. В самом ответе названия не имеет. Содержит следующие поля:
    - `u: Int[]` – массив из 30 элементов, показывающих количество обновлений темы, по аналогии с `mainUpdatesCount`.
      Данное поле может отсутствовать, что означает, что тема обновлялась столько же раз, сколько и БД, и для расчёта
      сидов в таком случае следует использовать `mainUpdatesCount`
    - `s: Int[]` — массив из 30 элементов, показывающих сумму сидов в каждый из 30-ти дней. Получение среднего
      количества сидов осуществляется делением суммы сидов в этот день на количество обновлений в этот день. Данное
      действие должен выполнять уже сам клиент. Если в этот день 0 обновлений, то количество сидов не определено

**Пример ответа:**

```
{
    "message": "Курить вредно, если что",
    "mainUpdatesCount": [20,24,24,24,24,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    "subsections":{
        "1":{
            "1001":{
                "s":[63,94,113,93,96,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            },
            "1003":{
                "s":[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                "u":[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            }
        },
        "2":{}
    }
}
```

### GET /currentDay

**Параметры:**

нет

**Ответ:**

- ~~`success: Boolean`~~ — удалён из API, так как есть коды ответа
- `message: String` — сообщение, которое следует дополнительно вывести пользователю. Всегда присутствует при ошибке,
  может присутствовать при успешном запросе и носить информационный характер
- `currentDay: Int` — номер текущего дня в БД относительно начала эпохи Unix. Дни считаются по московскому времени, во избежание путаницы

### GET /version

**Параметры:**

нет

**Ответ:**

- `version: Int` — номер версии. Имеет вид "<мажор>.<минор>.<патч>[-снапшот]"

## Надёжность

В настоящее время надёжность получения сидов обеспечивается двумя узлами, находящимися в разных местах. Все сервера
собирают сиды в одно и то же время и синхронизируется через API после первого обновления за день (обычно в 00:30-01:00
МСК), что позволяет иметь актуальные данные о сидах даже при временной неработоспособности основного узла. Такая система
однако не защищает от проблем со стороны трекера, поэтому в случаях, когда невозможно получить сиды от трекера,
обновление пропускается.

## Ограничения и известные проблемы

- **Нельзя получить сиды на текущий день.** Это сделано намеренно, так как сиды считаются именно по дням, а не по часам,
  соответственно виды за текущий день могут быть собраны только в конце дня
- ~~**Нельзя установить количество дней для запроса.**~~ В новых версиях клиент может указать дни в параметре "days"
- **Нет ограничений на запрос.** ~~Ограничением отсутствие ограничения является в том плане, что попытка запросить
  огромное количество подразделов сразу может уронить сервер.~~ Клиент может запросить сколько угодно данных, если готов
  ожидать их получения и готов их принять
- ~~**Не ведётся учёт дня в постоянной памяти.**~~ День считается от начала эпохи Unix и хранится в базе данных. 
  Если база не обновлялась сколько-то дней, сервис корректно обрабатывает смещение и затирает старые данные

## Тестовый контур

Тестовая база доступна по адресу https://seeds-test.huku.one/. Она также собирает сиды, но работает отдельно от
основной, так что не страшно, если она упадёт
